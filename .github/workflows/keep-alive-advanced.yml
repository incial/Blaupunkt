name: Advanced Keep-Alive with Monitoring

# Runs every 5 minutes + sends notifications on failures
on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

jobs:
  keep-alive:
    runs-on: ubuntu-latest
    
    steps:
      - name: Check Backend Health
        id: health_check
        run: |
          echo "ğŸ“ Pinging Render backend..."
          
          BACKEND_URL="${{ secrets.BACKEND_URL }}"
          if [ -z "$BACKEND_URL" ]; then
            BACKEND_URL="https://blaupunkt-backend.onrender.com"
          fi
          
          # Get response with timing
          START_TIME=$(date +%s)
          RESPONSE=$(curl -s -o response.json -w "%{http_code}" "$BACKEND_URL/api/health")
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          
          echo "status_code=$RESPONSE" >> $GITHUB_OUTPUT
          echo "duration=$DURATION" >> $GITHUB_OUTPUT
          
          if [ $RESPONSE -eq 200 ]; then
            echo "âœ… Backend is healthy! (${DURATION}s)"
            cat response.json | jq '.' || cat response.json
          else
            echo "âŒ Backend health check failed! (HTTP $RESPONSE)"
            cat response.json 2>/dev/null || echo "No response body"
            exit 1
          fi
      
      - name: Test Contact Endpoint
        if: success()
        run: |
          echo "ğŸ“§ Testing contact endpoint availability..."
          
          BACKEND_URL="${{ secrets.BACKEND_URL }}"
          if [ -z "$BACKEND_URL" ]; then
            BACKEND_URL="https://blaupunkt-backend.onrender.com"
          fi
          
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" -X OPTIONS "$BACKEND_URL/api/contact")
          
          if [ $RESPONSE -eq 200 ] || [ $RESPONSE -eq 204 ]; then
            echo "âœ… Contact endpoint is responsive"
          else
            echo "âš ï¸ Contact endpoint: HTTP $RESPONSE (may be normal for OPTIONS)"
          fi
      
      - name: Log Success
        if: success()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Keep-Alive Success"
          echo "â° Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ğŸš€ Status: Backend is warm and ready"
          echo "âš¡ Response Time: ${{ steps.health_check.outputs.duration }}s"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      
      - name: Report Failure
        if: failure()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âŒ Keep-Alive Failed"
          echo "â° Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ğŸš¨ Backend may be down or experiencing issues"
          echo "ğŸ“Š Status Code: ${{ steps.health_check.outputs.status_code }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # You can add notification here (email, Slack, Discord, etc.)
          # Example: curl webhook to notify you of failures
